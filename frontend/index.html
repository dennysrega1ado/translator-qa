<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation QA System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <div class="login-container">
                <h1>Translation QA System</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <div id="login-error" class="error-message"></div>
                </form>
                <div class="login-footer">
                    <img src="powered_by.png" alt="Powered By" class="login-footer-image">
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-screen" class="screen hidden">
            <nav class="navbar">
                <div class="nav-brand">Translation QA</div>
                <div class="nav-menu">
                    <a href="#" data-view="translations" class="nav-link active">Translations</a>
                    <a href="#" data-view="summary" class="nav-link">Summary</a>
                    <a href="#" data-view="reports" class="nav-link admin-only">Reports</a>
                    <a href="#" data-view="admin" class="nav-link admin-only">Admin</a>
                </div>
                <div class="nav-user">
                    <span id="current-user"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </nav>

            <div class="container">
                <!-- Translations View -->
                <div id="translations-view" class="view">
                    <!-- Translation Review Dashboard -->
                    <div id="translation-dashboard" class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-8 hidden">
                        <div class="max-w-7xl mx-auto">
                            <!-- Filters Section (Always Visible) -->
                            <div class="mb-8">
                                <div class="mb-4">
                                    <h1 class="text-4xl font-bold text-slate-800 mb-2">Translation Review Dashboard</h1>
                                    <p class="text-slate-600" id="translation-languages">English â†’ Spanish</p>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div>
                                        <!-- Execution Filter -->
                                        <div class="mb-3">
                                            <label for="execution-filter" class="text-sm font-medium text-slate-700 mr-2">Execution:</label>
                                            <select id="execution-filter" class="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" style="min-width: 300px;" disabled>
                                                <option value="">No Executions Available</option>
                                            </select>
                                        </div>

                                        <!-- Filter Buttons -->
                                        <div class="inline-flex rounded-lg border border-slate-300 bg-white shadow-sm" role="group">
                                            <button
                                                id="filter-all"
                                                class="filter-btn px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 rounded-l-lg border-r border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 active"
                                                data-filter="all">
                                                All
                                            </button>
                                            <button
                                                id="filter-unreviewed"
                                                class="filter-btn px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 border-r border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                data-filter="unreviewed">
                                                Unreviewed
                                            </button>
                                            <button
                                                id="filter-reviewed"
                                                class="filter-btn px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                data-filter="reviewed">
                                                Reviewed
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Search and Pagination Controls (hidden when no content) -->
                                    <div id="translation-controls" class="flex items-center gap-4">
                                        <div class="flex items-center gap-2">
                                            <input
                                                type="text"
                                                id="search-translation-id"
                                                placeholder="Search by ID (e.g., 245db4...)"
                                                class="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                style="width: 200px;"
                                            >
                                            <button id="search-translation-btn" class="px-3 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 flex items-center gap-1">
                                                <span class="material-icons" style="font-size: 18px;">search</span>
                                            </button>
                                        </div>
                                        <span class="text-slate-600 font-medium" id="pagination-info">1 of 1</span>
                                        <button id="prev-translation" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                            <span class="material-icons">chevron_left</span>
                                            Previous
                                        </button>
                                        <button id="next-translation" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                            Next
                                            <span class="material-icons">chevron_right</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Translation Content (hidden when no translations) -->
                            <div id="translation-content">
                            <!-- Metrics Dashboard -->
                            <div class="mb-8">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="material-icons text-blue-600">trending_up</span>
                                    <h2 class="text-xl font-bold text-slate-800" id="translation-id-subtitle">Quality Metrics</h2>
                                    <div class="ml-auto bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl shadow-lg">
                                        <div class="text-xs font-medium uppercase tracking-wide opacity-90">Overall LLM Score</div>
                                        <div class="text-3xl font-bold" id="global-llm-score">0.00</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-6" id="metrics-grid">
                                    <!-- Metrics will be inserted here -->
                                </div>
                            </div>

                            <!-- Side by Side Comparison -->
                            <div class="grid grid-cols-2 gap-6">
                                <!-- English Original -->
                                <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-slate-200">
                                    <div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white px-6 py-4 font-semibold flex items-center justify-between">
                                        <span>Original Text (English)</span>
                                        <span class="text-xs bg-white/20 px-3 py-1 rounded-full">Source</span>
                                    </div>
                                    <div class="p-6">
                                        <div id="original-text" class="text-slate-800 leading-relaxed text-lg"></div>
                                    </div>
                                </div>

                                <!-- Spanish Translation -->
                                <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-blue-200">
                                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 font-semibold flex items-center justify-between">
                                        <span>Translation (Spanish)</span>
                                        <span class="text-xs bg-white/20 px-3 py-1 rounded-full">Target</span>
                                    </div>
                                    <div class="p-6">
                                        <div id="translated-text" class="text-slate-800 leading-relaxed text-lg"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <div class="mt-8">
                                <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-slate-200">
                                    <div class="bg-gradient-to-r from-slate-600 to-slate-700 text-white px-6 py-4 font-semibold flex items-center gap-2">
                                        <span class="material-icons">comment</span>
                                        <span>Additional Comments (Optional)</span>
                                    </div>
                                    <div class="p-6">
                                        <textarea
                                            id="review-notes"
                                            rows="4"
                                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-slate-800"
                                            placeholder="Add any notes or observations about this translation..."
                                        ></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="mt-8 flex justify-end">
                                <button id="submit-review" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-8 py-3 rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    Submit Review
                                </button>
                            </div>
                            </div>
                            <!-- End Translation Content -->

                            <!-- Empty State (shown when no translations) -->
                            <div id="translations-empty" class="text-center py-20 hidden">
                                <span class="material-icons text-slate-300" style="font-size: 64px;">translate</span>
                                <p class="mt-4 text-slate-600">No translations available</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="translations-loading" class="text-center py-20">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                        <p class="mt-4 text-slate-600">Loading translations...</p>
                    </div>
                </div>

                <!-- Summary View -->
                <div id="summary-view" class="view hidden">
                    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-8">
                        <div class="max-w-7xl mx-auto">
                            <!-- Header Section -->
                            <div class="mb-8">
                                <div class="mb-4">
                                    <h1 class="text-4xl font-bold text-slate-800 mb-2">Overall Quality Summary</h1>
                                </div>

                                <!-- Filters -->
                                <div class="flex items-center justify-between">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label for="summary-execution-filter" class="text-sm font-medium text-slate-700 mr-2">Execution:</label>
                                        <select id="summary-execution-filter" class="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" style="min-width: 300px;" disabled>
                                            <option value="">No Executions Available</option>
                                        </select>
                                        <button id="apply-summary-filters" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">Apply</button>
                                    </div>
                                    <button id="export-reviews-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                        <span class="material-icons" style="font-size: 20px;">download</span>
                                        Export
                                    </button>
                                </div>
                            </div>

                            <!-- Content Section -->
                        <!-- Stats Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Translations</div>
                                <div class="stat-value" id="summary-total-translations">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Reviewed</div>
                                <div class="stat-value" id="summary-reviewed">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Coverage</div>
                                <div class="stat-value" id="summary-coverage">-</div>
                            </div>
                        </div>

                        <!-- Main Content: Chart and Contributors -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <!-- Chart -->
                            <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 20px; text-align: center;">Overall Quality Score</h3>
                                <div style="position: relative; height: 300px;">
                                    <canvas id="quality-chart"></canvas>
                                </div>
                                <div id="chart-legend" style="margin-top: 20px; text-align: center;"></div>
                            </div>

                            <!-- Contributors -->
                            <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 20px;">Contributors</h3>
                                <div id="contributors-list"></div>
                            </div>
                        </div>

                        <!-- Detailed Metrics -->
                        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin-bottom: 20px;">Average Manual Scores</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div class="metric-item">
                                    <div class="metric-label">Coherence</div>
                                    <div class="metric-value" id="summary-coherence">-</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Fidelity</div>
                                    <div class="metric-value" id="summary-fidelity">-</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Naturalness</div>
                                    <div class="metric-value" id="summary-naturalness">-</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Overall</div>
                                    <div class="metric-value" id="summary-overall">-</div>
                                </div>
                            </div>
                        </div>
                        </div> <!-- End max-w-7xl mx-auto -->
                    </div> <!-- End min-h-screen bg-gradient -->
                </div> <!-- End summary-view -->

                <!-- Reports View -->
                <div id="reports-view" class="view hidden">
                    <div class="view-header">
                        <h2>Reports</h2>
                        <div class="filters">
                            <select id="report-execution-filter" class="filter-select" disabled>
                                <option value="">No Executions Available</option>
                            </select>
                            <select id="report-prompt-filter" class="filter-select">
                                <option value="">All Prompts</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" id="manual-only-filter">
                                Show only manual scores
                            </label>
                            <button id="apply-report-filters" class="btn btn-primary">Apply</button>
                        </div>
                    </div>

                    <div id="reports-list" class="reports-list"></div>
                </div>

                <!-- Admin View -->
                <div id="admin-view" class="view hidden">
                    <div class="view-header">
                        <h2>Admin Panel</h2>
                    </div>

                    <div class="admin-section">
                        <h3>Create New User</h3>
                        <form id="create-user-form">
                            <div class="form-group">
                                <label for="new-username">Username</label>
                                <input type="text" id="new-username" name="username" required>
                            </div>
                            <div class="form-group">
                                <label for="new-email">Email</label>
                                <input type="email" id="new-email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">Password</label>
                                <input type="password" id="new-password" name="password" required>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="new-is-admin" name="is_admin">
                                    Admin User
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Create User</button>
                            <div id="create-user-message" class="message"></div>
                        </form>
                    </div>

                    <div class="admin-section">
                        <h3>Users List</h3>
                        <div id="users-list" class="users-list"></div>
                    </div>

                    <div class="admin-section">
                        <h3>Load Translations from S3</h3>
                        <div class="s3-loader-form">
                            <div class="form-group">
                                <label for="s3-bucket-name">S3 Bucket</label>
                                <input type="text" id="s3-bucket-name" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label for="s3-prefix">S3 Prefix</label>
                                <input type="text" id="s3-prefix" value="translations/llm-output/2025/10/latest" placeholder="e.g., translations/batch-01">
                                <small class="form-help">Enter the S3 prefix containing en/ and es/ folders</small>
                            </div>
                            <div class="form-group">
                                <label for="s3-description">Description *</label>
                                <input type="text" id="s3-description" placeholder="e.g., October 2024 translations" required>
                                <small class="form-help">Enter a description for this execution (required)</small>
                            </div>
                            <div class="s3-actions">
                                <button id="validate-prefix-btn" class="btn btn-secondary">Validate Prefix</button>
                                <button id="load-translations-btn" class="btn btn-primary" disabled>Load Translations</button>
                            </div>
                            <div id="s3-validation-result" class="message"></div>
                            <div id="s3-load-result" class="message"></div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Clean Database Tables</h3>
                        <div class="clean-tables-form">
                            <div class="warning-box">
                                <span class="material-icons">warning</span>
                                <div class="warning-content">
                                    <strong>Warning: This action cannot be undone!</strong>
                                    <p>This will permanently delete all data from the following tables:</p>
                                    <ul>
                                        <li>Manual Scores</li>
                                        <li>Translations</li>
                                        <li>Prompts</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="clean-actions">
                                <button id="clean-tables-btn" class="btn btn-danger">Clean All Tables</button>
                            </div>
                            <div id="clean-tables-result" class="message"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation Detail Modal -->
    <div id="translation-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Translation Details</h2>
            <div id="translation-detail"></div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="export-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="export-modal-close">&times;</span>
            <h2>Export Options</h2>

            <div style="margin: 20px 0;">
                <!-- Executions Selection -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Executions</h3>
                    <div style="margin-bottom: 10px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-all-executions" checked>
                            All Executions
                        </label>
                    </div>
                    <div id="export-executions-list" style="margin-left: 25px; max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                        <!-- Execution checkboxes will be populated here -->
                    </div>
                </div>

                <!-- User Reviews Filter -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Reviews</h3>
                    <div style="margin-bottom: 10px;">
                        <label class="checkbox-label">
                            <input type="radio" name="export-user-filter" value="my-reviews" checked>
                            Only My Reviews
                        </label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label class="checkbox-label">
                            <input type="radio" name="export-user-filter" value="all-reviews">
                            All Users Reviews
                        </label>
                    </div>
                </div>

                <!-- Include Unreviewed -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Include Translations</h3>
                    <div style="margin-bottom: 10px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="export-include-unreviewed">
                            Include translations without reviews
                        </label>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="export-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="export-confirm-btn" class="btn btn-primary">
                    <span class="material-icons" style="font-size: 20px; margin-right: 5px;">download</span>
                    Export to Excel
                </button>
            </div>
            <div id="export-message" class="message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Success Animation Overlay -->
    <div id="success-overlay" class="success-overlay hidden">
        <div class="success-checkmark">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
    </div>

    <!-- All Done Modal -->
    <div id="all-done-modal" class="all-done-modal hidden">
        <div class="all-done-content">
            <div class="celebration-animation">
                <span class="celebration-emoji">ðŸŽ‰</span>
                <span class="celebration-emoji">âœ¨</span>
                <span class="celebration-emoji">ðŸŽŠ</span>
            </div>
            <h2 class="all-done-title">All Done!</h2>
            <p class="all-done-message">You've reviewed all pending translations.</p>
            <button id="close-all-done" class="btn btn-primary">Continue Reviewing</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2 class="loading-title">Loading Translations from S3</h2>
            <p class="loading-message">Please wait while we load the translations...</p>
            <p class="loading-hint">This may take a few moments</p>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="app_pagination.js"></script>
    <script>
        // Add pagination event listeners after DOM is loaded
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const prevBtn = document.getElementById('prev-translation');
                const nextBtn = document.getElementById('next-translation');
                const submitBtn = document.getElementById('submit-review');
                const searchBtn = document.getElementById('search-translation-btn');
                const searchInput = document.getElementById('search-translation-id');
                const filterBtns = document.querySelectorAll('.filter-btn');

                if (prevBtn) prevBtn.addEventListener('click', () => navigateTranslation(-1));
                if (nextBtn) nextBtn.addEventListener('click', () => navigateTranslation(1));
                if (submitBtn) submitBtn.addEventListener('click', submitCurrentReview);
                if (searchBtn) searchBtn.addEventListener('click', searchTranslationById);

                // Allow Enter key to trigger search
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            searchTranslationById();
                        }
                    });
                }

                // Filter buttons - reload translations when clicked
                filterBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Remove active class from all buttons
                        filterBtns.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');
                        // Reload translations with new filter
                        if (typeof loadTranslationsPaginated === 'function') {
                            loadTranslationsPaginated();
                        }
                    });
                });

                // Execution filter - reload translations when changed
                const executionFilter = document.getElementById('execution-filter');
                if (executionFilter) {
                    executionFilter.addEventListener('change', handleExecutionFilterChange);
                }

                // All done modal close button
                const allDoneBtn = document.getElementById('close-all-done');
                if (allDoneBtn) {
                    allDoneBtn.addEventListener('click', function() {
                        document.getElementById('all-done-modal').classList.add('hidden');
                        // Switch to "All" filter to show all translations
                        document.getElementById('filter-all').click();
                    });
                }

                // Export reviews button
                const exportBtn = document.getElementById('export-reviews-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportReviews);
                }
            }, 500);
        });
    </script>
</body>
</html>
